name: Auto Update

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_test:
        description: 'Force update for testing (ignore version/url compare)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    container: archlinux:latest
    env:
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
    defaults:
      run:
        shell: bash

    steps:
      - name: Install Dependencies
        run: |
          set -euo pipefail
          pacman -Syu --noconfirm --needed \
            ca-certificates git base-devel jq curl openssh util-linux
          update-ca-trust || true
          git --version
          jq --version
          curl --version
          ssh -V || true

      - name: Prepare builder user and repo dir
        run: |
          set -euo pipefail
          id -u builder >/dev/null 2>&1 || useradd -m builder
          rm -rf /repo
          mkdir -p /repo
          chown -R builder:builder /repo

      - name: Clone repo (clean, real .git)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REF_NAME: ${{ github.ref_name }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          ref="${REF_NAME:-main}"

          # 用 builder clone，避免后续所有权/安全目录问题
          runuser -u builder -- bash -lc "
            set -euo pipefail
            cd /
            git clone --branch \"$ref\" \
              \"https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git\" /repo
            cd /repo
            test -d .git
            git rev-parse --show-toplevel
          "

      - name: Update PKGBUILD
        env:
          FORCE_TEST: ${{ inputs.force_test || 'false' }}
        run: |
          set -euo pipefail
          runuser -u builder -- bash -lc "
            set -euo pipefail
            cd /repo
            FORCE_TEST='${FORCE_TEST}' ./scripts/update.sh
          "

      - name: Detect Changes
        id: diff
        run: |
          set -euo pipefail
          changed="$(runuser -u builder -- bash -lc '
            set -euo pipefail
            cd /repo
            test -d .git
            if git diff --quiet; then echo false; else echo true; fi
          ')"
          echo "changed=${changed}" >> "$GITHUB_OUTPUT"

      - name: Commit And Push
        if: steps.diff.outputs.changed == 'true'
        run: |
          set -euo pipefail
          runuser -u builder -- bash -lc "
            set -euo pipefail
            cd /repo
            test -d .git

            ver=\$(sed -n 's/^_upstream_ver=//p' PKGBUILD | head -n1 | tr -d '\r\n')
            if [[ -z \"\$ver\" ]]; then
              echo 'Cannot read _upstream_ver from PKGBUILD' >&2
              exit 1
            fi

            git config user.name 'github-actions[bot]'
            git config user.email 'github-actions[bot]@users.noreply.github.com'

            git add PKGBUILD .SRCINFO
            git commit -m \"chore: update to \${ver}\"
            git push origin HEAD
          "

      - name: Push To AUR
        if: steps.diff.outputs.changed == 'true'
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          AUR_USERNAME: ${{ secrets.AUR_USERNAME }}
          AUR_PKGNAME: layaair-ide
        run: |
          set -euo pipefail

          if [[ -z "${AUR_SSH_PRIVATE_KEY:-}" || -z "${AUR_USERNAME:-}" ]]; then
            echo "Missing AUR secrets" >&2
            exit 1
          fi

          # 在 builder 的 HOME 下写 ssh 配置，保证 ssh 也用 builder 的环境
          runuser -u builder -- bash -lc "
            set -euo pipefail
            cd /repo

            mkdir -p ~/.ssh
            chmod 700 ~/.ssh

            echo '${AUR_SSH_PRIVATE_KEY}' > ~/.ssh/id_ed25519
            chmod 600 ~/.ssh/id_ed25519

            ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts
            chmod 600 ~/.ssh/known_hosts

            git remote remove aur 2>/dev/null || true
            git remote add aur 'ssh://${AUR_USERNAME}@aur.archlinux.org/${AUR_PKGNAME}.git'
            git push aur HEAD:master
          "
