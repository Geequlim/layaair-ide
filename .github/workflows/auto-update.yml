name: Auto Update

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    container: archlinux:latest
    env:
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
    defaults:
      run:
        shell: bash

    steps:
      # 1) 先 checkout（不依赖容器内 git）
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) 先把 git 装上：后面任何 git 命令都不会炸
      - name: Bootstrap (install git)
        run: |
          pacman -Sy --noconfirm --needed ca-certificates git
          update-ca-trust || true
          git --version

      # 3) 再做 workspace debug（此时 git 已经存在）
      - name: Debug workspace
        working-directory: ${{ github.workspace }}
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          echo "pwd=$(pwd)"
          ls -la
          git rev-parse --show-toplevel
          git status --porcelain || true

      # 4) 其余依赖（你脚本需要啥就装啥）
      - name: Install Dependencies
        run: |
          pacman -Sy --noconfirm --needed base-devel jq curl openssh

      - name: Update PKGBUILD
        working-directory: ${{ github.workspace }}
        run: ./scripts/update.sh

      - name: Detect Changes
        id: diff
        working-directory: ${{ github.workspace }}
        run: |
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit And Push
        if: steps.diff.outputs.changed == 'true'
        working-directory: ${{ github.workspace }}
        run: |
          ver="$(sed -n 's/^_upstream_ver=//p' PKGBUILD | head -n1 | tr -d '\r\n')"
          if [[ -z "$ver" ]]; then
            echo "Cannot read _upstream_ver from PKGBUILD" >&2
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add PKGBUILD .SRCINFO
          git commit -m "chore: update to ${ver}"
          git push

      - name: Push To AUR
        if: steps.diff.outputs.changed == 'true'
        working-directory: ${{ github.workspace }}
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          AUR_USERNAME: ${{ secrets.AUR_USERNAME }}
          AUR_PKGNAME: layaair-ide
        run: |
          if [[ -z "${AUR_SSH_PRIVATE_KEY}" || -z "${AUR_USERNAME}" ]]; then
            echo "Missing AUR secrets" >&2
            exit 1
          fi

          mkdir -p ~/.ssh
          echo "$AUR_SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts

          git remote remove aur 2>/dev/null || true
          git remote add aur "ssh://${AUR_USERNAME}@aur.archlinux.org/${AUR_PKGNAME}.git"
          git push aur HEAD:master
