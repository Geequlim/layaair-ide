name: Auto Update

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    container: archlinux:latest
    env:
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout (best effort)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Dependencies
        run: |
          pacman -Syu --noconfirm --needed \
            ca-certificates git base-devel jq curl openssh
          update-ca-trust || true
          git --version

      - name: Ensure git repository (recreate .git if missing)
        working-directory: ${{ github.workspace }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          ls -la

          if [[ -d .git ]]; then
            echo ".git exists, OK"
            git rev-parse --show-toplevel
            exit 0
          fi

          echo "No .git found; recreating repository metadata..."

          # init an empty repo on top of the checked-out files
          git init

          # set origin using GITHUB_TOKEN so push works
          git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"

          # fetch the branch that triggered the workflow (fallback to default)
          ref="${GITHUB_REF_NAME:-}"
          if [[ -z "$ref" ]]; then
            ref="$(echo "${GITHUB_REF}" | sed 's#refs/heads/##')"
          fi
          if [[ -z "$ref" || "$ref" == "$GITHUB_REF" ]]; then
            ref="main"
          fi
          echo "Using ref=$ref"

          git fetch --no-tags --prune origin "+refs/heads/${ref}:refs/remotes/origin/${ref}"

          # create local branch tracking origin
          git checkout -B "${ref}" "origin/${ref}"

          # now the working tree should match remote, but our current files are already present.
          # stage refresh to reconcile index
          git status --porcelain

      - name: Update PKGBUILD
        working-directory: ${{ github.workspace }}
        run: ./scripts/update.sh

      - name: Detect Changes
        id: diff
        working-directory: ${{ github.workspace }}
        run: |
          if git diff --quiet; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit And Push
        if: steps.diff.outputs.changed == 'true'
        working-directory: ${{ github.workspace }}
        run: |
          ver="$(sed -n 's/^_upstream_ver=//p' PKGBUILD | head -n1 | tr -d '\r\n')"
          if [[ -z "$ver" ]]; then
            echo "Cannot read _upstream_ver from PKGBUILD" >&2
            exit 1
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add PKGBUILD .SRCINFO
          git commit -m "chore: update to ${ver}"
          git push origin HEAD

      - name: Push To AUR
        if: steps.diff.outputs.changed == 'true'
        working-directory: ${{ github.workspace }}
        env:
          AUR_SSH_PRIVATE_KEY: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          AUR_USERNAME: ${{ secrets.AUR_USERNAME }}
          AUR_PKGNAME: layaair-ide
        run: |
          if [[ -z "${AUR_SSH_PRIVATE_KEY}" || -z "${AUR_USERNAME}" ]]; then
            echo "Missing AUR secrets" >&2
            exit 1
          fi

          mkdir -p ~/.ssh
          echo "$AUR_SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H aur.archlinux.org >> ~/.ssh/known_hosts

          git remote remove aur 2>/dev/null || true
          git remote add aur "ssh://${AUR_USERNAME}@aur.archlinux.org/${AUR_PKGNAME}.git"
          git push aur HEAD:master
